<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <base data-ice="baseUrl" href="../../">
  <title data-ice="title">src/ESDoc.js | ESDoc API Document</title>
  <link type="text/css" rel="stylesheet" href="css/style.css">
  <link type="text/css" rel="stylesheet" href="css/prettify-tomorrow.css">
  <script src="script/prettify/prettify.js"></script>
  
  
</head>
<body class="layout-container">

<header>
  <a href="./">Home</a>
  <a href="identifiers.html">Identifier</a>
  <a href="source.html">Source</a>
  <a href="test.html" data-ice="testLink">Test</a>
  <a data-ice="repoURL" href="https://github.com/h13i32maru/esdoc" class="repo-url-github">Repository</a>
  <div class="search-box">
  <span>
    <img src="./image/search.png">
    <span class="search-input-edge"></span><input class="search-input"><span class="search-input-edge"></span>
  </span>
    <ul class="search-result"></ul>
  </div>
</header>

<nav class="navigation" data-ice="nav"><div data-ice="classWrap">
  <h2>Class</h2>
  <ul>
    
  <li data-ice="classDoc"><span><a href="class/src/Publisher/Builder/ASTDocBuilder.js~ASTDocBuilder.html">ASTDocBuilder</a></span></li>
<li data-ice="classDoc"><span><a href="class/src/Util/ASTUtil.js~ASTUtil.html">ASTUtil</a></span></li>
<li data-ice="classDoc"><span><a href="class/src/Doc/AbstractDoc.js~AbstractDoc.html">AbstractDoc</a></span></li>
<li data-ice="classDoc"><span><a href="class/src/Doc/AssignmentDoc.js~AssignmentDoc.html">AssignmentDoc</a></span></li>
<li data-ice="classDoc"><span><a href="class/src/Doc/ClassDoc.js~ClassDoc.html">ClassDoc</a></span></li>
<li data-ice="classDoc"><span><a href="class/src/Publisher/Builder/ClassDocBuilder.js~ClassDocBuilder.html">ClassDocBuilder</a></span></li>
<li data-ice="classDoc"><span><a href="class/src/Parser/CommentParser.js~CommentParser.html">CommentParser</a></span></li>
<li data-ice="classDoc"><span><a href="class/src/Publisher/Builder/CoverageBuilder.js~CoverageBuilder.html">CoverageBuilder</a></span></li>
<li data-ice="classDoc"><span><a href="class/src/Publisher/Builder/DocBuilder.js~DocBuilder.html">DocBuilder</a></span></li>
<li data-ice="classDoc"><span><a href="class/src/Factory/DocFactory.js~DocFactory.html">DocFactory</a></span></li>
<li data-ice="classDoc"><span><a href="class/src/Publisher/Builder/DocResolver.js~DocResolver.html">DocResolver</a></span></li>
<li data-ice="classDoc"><span><a href="class/src/ESDoc.js~ESDoc.html">ESDoc</a></span></li>
<li data-ice="classDoc"><span><a href="class/src/ESDocCLI.js~ESDocCLI.html">ESDocCLI</a></span></li>
<li data-ice="classDoc"><span><a href="class/src/Parser/ESParser.js~ESParser.html">ESParser</a></span></li>
<li data-ice="classDoc"><span><a href="class/src/Doc/ExternalDoc.js~ExternalDoc.html">ExternalDoc</a></span></li>
<li data-ice="classDoc"><span><a href="class/src/Doc/FileDoc.js~FileDoc.html">FileDoc</a></span></li>
<li data-ice="classDoc"><span><a href="class/src/Publisher/Builder/FileDocBuilder.js~FileDocBuilder.html">FileDocBuilder</a></span></li>
<li data-ice="classDoc"><span><a href="class/src/Publisher/Builder/TestFileDocBuilder.js~FileDocBuilder.html">FileDocBuilder</a></span></li>
<li data-ice="classDoc"><span><a href="class/src/Doc/FunctionDoc.js~FunctionDoc.html">FunctionDoc</a></span></li>
<li data-ice="classDoc"><span><a href="class/src/Publisher/Builder/IdentifiersDocBuilder.js~IdentifiersDocBuilder.html">IdentifiersDocBuilder</a></span></li>
<li data-ice="classDoc"><span><a href="class/src/Publisher/Builder/IndexDocBuilder.js~IndexDocBuilder.html">IndexDocBuilder</a></span></li>
<li data-ice="classDoc"><span><a href="class/src/Doc/MemberDoc.js~MemberDoc.html">MemberDoc</a></span></li>
<li data-ice="classDoc"><span><a href="class/src/Doc/MethodDoc.js~MethodDoc.html">MethodDoc</a></span></li>
<li data-ice="classDoc"><span><a href="class/src/Parser/ParamParser.js~ParamParser.html">ParamParser</a></span></li>
<li data-ice="classDoc"><span><a href="class/src/Util/PathResolver.js~PathResolver.html">PathResolver</a></span></li>
<li data-ice="classDoc"><span><a href="class/src/Publisher/Builder/SearchIndexBuilder.js~SearchIndexBuilder.html">SearchIndexBuilder</a></span></li>
<li data-ice="classDoc"><span><a href="class/src/Publisher/Builder/SingleDocBuilder.js~SingleDocBuilder.html">SingleDocBuilder</a></span></li>
<li data-ice="classDoc"><span><a href="class/src/Publisher/Builder/SourceDocBuilder.js~SourceDocBuilder.html">SourceDocBuilder</a></span></li>
<li data-ice="classDoc"><span><a href="class/src/Publisher/Builder/StaticFileBuilder.js~StaticFileBuilder.html">StaticFileBuilder</a></span></li>
<li data-ice="classDoc"><span><a href="class/src/Doc/TestDoc.js~TestDoc.html">TestDoc</a></span></li>
<li data-ice="classDoc"><span><a href="class/src/Publisher/Builder/TestDocBuilder.js~TestDocBuilder.html">TestDocBuilder</a></span></li>
<li data-ice="classDoc"><span><a href="class/src/Factory/TestDocFactory.js~TestDocFactory.html">TestDocFactory</a></span></li>
<li data-ice="classDoc"><span><a href="class/src/Doc/TestFileDoc.js~TestFileDoc.html">TestFileDoc</a></span></li>
<li data-ice="classDoc"><span><a href="class/src/Doc/TypedefDoc.js~TypedefDoc.html">TypedefDoc</a></span></li>
<li data-ice="classDoc"><span><a href="class/src/Doc/VariableDoc.js~VariableDoc.html">VariableDoc</a></span></li>
</ul>
</div>



<div data-ice="functionWrap">
  <h2><a href="function/">Function</a></h2>
  <ul>
    
  <li data-ice="functionDoc"><span><a href="function/index.html#static-function-dateForUTC">dateForUTC</a></span></li>
<li data-ice="functionDoc"><span><a href="function/index.html#static-function-markdown">markdown</a></span></li>
<li data-ice="functionDoc"><span><a href="function/index.html#static-function-publish">publish</a></span></li>
<li data-ice="functionDoc"><span><a href="function/index.html#static-function-shorten">shorten</a></span></li>
</ul>
</div>



<div data-ice="typedefWrap">
  <h2><a href="typedef/">Typedef</a></h2>
  <ul>
    
  <li data-ice="typedefDoc"><span><a href="typedef/index.html#static-typedef-CoverageObject">CoverageObject</a></span></li>
<li data-ice="typedefDoc"><span><a href="typedef/index.html#static-typedef-DocObject">DocObject</a></span></li>
<li data-ice="typedefDoc"><span><a href="typedef/index.html#static-typedef-DocTypedef">DocTypedef</a></span></li>
<li data-ice="typedefDoc"><span><a href="typedef/index.html#static-typedef-ESDocCLIArgv">ESDocCLIArgv</a></span></li>
<li data-ice="typedefDoc"><span><a href="typedef/index.html#static-typedef-ESDocConfig">ESDocConfig</a></span></li>
<li data-ice="typedefDoc"><span><a href="typedef/index.html#static-typedef-IceCapInstanceTypedef">IceCapInstanceTypedef</a></span></li>
<li data-ice="typedefDoc"><span><a href="typedef/index.html#static-typedef-PackageTypedef">PackageTypedef</a></span></li>
<li data-ice="typedefDoc"><span><a href="typedef/index.html#static-typedef-ParsedParam">ParsedParam</a></span></li>
<li data-ice="typedefDoc"><span><a href="typedef/index.html#static-typedef-TaffyCursor">TaffyCursor</a></span></li>
<li data-ice="typedefDoc"><span><a href="typedef/index.html#static-typedef-Tag">Tag</a></span></li>
</ul>
</div>

<div data-ice="externalWrap">
  <h2>External</h2>
  <ul>
    
  <li data-ice="externalDoc"><span><a href="https://github.com/estree/estree">AST</a></span></li>
<li data-ice="externalDoc"><span><a href="https://github.com/estree/estree">ASTNode</a></span></li>
<li data-ice="externalDoc"><span><a href="https://github.com/h13i32maru/ice-cap">IceCap</a></span></li>
<li data-ice="externalDoc"><span><a href="https://docs.npmjs.com/files/package.json">NPMPackageObject</a></span></li>
<li data-ice="externalDoc"><span><a href="http://www.taffydb.com/">Taffy</a></span></li>
</ul>
</div>
</nav>

<div class="content" data-ice="content"><h1 data-ice="title">src/ESDoc.js</h1>
<pre class="source-code line-number"><code class="prettyprint linenums" data-ice="content">import babel from &apos;babel/polyfill&apos;;
import fs from &apos;fs&apos;;
import path from &apos;path&apos;;
import assert from &apos;assert&apos;;
import Logger from &apos;color-logger&apos;;
import ASTUtil from &apos;./Util/ASTUtil.js&apos;;
import ESParser from &apos;./Parser/ESParser&apos;;
import PathResolver from &apos;./Util/PathResolver.js&apos;;
import DocFactory from &apos;./Factory/DocFactory.js&apos;;
import TestDocFactory from &apos;./Factory/TestDocFactory.js&apos;;

let logger = new Logger(&apos;ESDoc&apos;);

/**
 * API Documentation Generator.
 *
 * @example
 * let config = {source: &apos;./src&apos;, destination: &apos;./esdoc&apos;};
 * ESDoc.generate(config, (results, config)=&gt;{
 *   console.log(results);
 * });
 */
export default class ESDoc {
  /**
   * Generate documentation.
   * @param {ESDocConfig} config - config for generation.
   * @param {function(results: Object[], asts: Object[], config: ESDocConfig)} publisher - callback for output html.
   */
  static generate(config, publisher) {
    assert(typeof publisher === &apos;function&apos;);
    assert(config.source);
    assert(config.destination);

    this._setDefaultConfig(config);

    Logger.debug = !!config.debug;
    let includes = config.includes.map((v) =&gt; new RegExp(v));
    let excludes = config.excludes.map((v) =&gt; new RegExp(v));
    let pathPrefix = config.importPathPrefix;

    let packageName = null;
    let mainFilePath = null;
    if (config.package) {
      try {
        let packageJSON = fs.readFileSync(config.package, {encode: &apos;utf8&apos;});
        let packageConfig = JSON.parse(packageJSON);
        packageName = packageConfig.name;
        mainFilePath = packageConfig.main;
      } catch (e) {
        // ignore
      }
    }

    let results = [];
    let asts = [];

    this._walk(config.source, (filePath)=&gt;{
      let match = false;
      for (let reg of includes) {
        if (filePath.match(reg)) {
          match = true;
          break;
        }
      }
      if (!match) return;

      for (let reg of excludes) {
        if (filePath.match(reg)) return;
      }

      let temp = this._traverse(config.source, filePath, packageName, mainFilePath, pathPrefix);
      if (!temp) return;
      results.push(...temp.results);

      let relativeFilePath = path.relative(path.dirname(config.source), filePath);
      asts.push({filePath: &apos;source&apos; + path.sep + relativeFilePath, ast: temp.ast});
    });

    if (config.builtinExternal) {
      this._useBuiltinExternal(results);
    }

    if (config.test) {
      this._generateForTest(config, results, asts);
    }

    publisher(results, asts, config);
  }

  /**
   * Generate document from test code.
   * @param {ESDocConfig} config - config for generating.
   * @param {DocObject[]} results - push DocObject to this.
   * @param {AST[]} asts - push ast to this.
   * @private
   */
  static _generateForTest(config, results, asts) {
    let includes = config.test.includes.map((v) =&gt; new RegExp(v));
    let excludes = config.test.excludes.map((v) =&gt; new RegExp(v));

    this._walk(config.test.source, (filePath)=&gt;{
      let match = false;
      for (let reg of includes) {
        if (filePath.match(reg)) {
          match = true;
          break;
        }
      }
      if (!match) return;

      for (let reg of excludes) {
        if (filePath.match(reg)) return;
      }

      let temp = this._traverseForTest(config.test.type, config.test.source, filePath);
      if (!temp) return;
      results.push(...temp.results);

      let relativeFilePath = path.relative(path.dirname(config.test.source), filePath);
      asts.push({filePath: &apos;test&apos; + path.sep + relativeFilePath, ast: temp.ast});
    });
  }

  /**
   * set default config to specified config.
   * @param {ESDocConfig} config - specified config.
   * @private
   */
  static _setDefaultConfig(config) {
    if (!config.includes) config.includes = [&apos;\\.(js|es6)$&apos;];

    if (!config.excludes) config.excludes = [&apos;\\.config\\.(js|es6)$&apos;];

    if (!config.access) config.access = [&apos;public&apos;, &apos;protected&apos;];

    if (!(&apos;autoPrivate&apos; in config)) config.autoPrivate = true;

    if (!(&apos;unexportIdentifier&apos; in config)) config.unexportIdentifier = false;

    if (!(&apos;builtinExternal&apos; in config)) config.builtinExternal = true;

    if (!(&apos;undocumentIdentifier&apos; in config)) config.undocumentIdentifier = true;

    if (!(&apos;coverage&apos; in config)) config.coverage = true;

    if (!config.index) config.index = &apos;./README.md&apos;;

    if (!config.package) config.package = &apos;./package.json&apos;;

    if (!config.importPathPrefix) config.importPathPrefix = &apos;&apos;;

    if (!config.styles) config.styles = [];

    if (!config.scripts) config.scripts = [];

    if (config.test) {
      assert(config.test.type);
      assert(config.test.source);
      if (!config.test.includes) config.test.includes = [&apos;(spec|Spec|test|Test)\\.(js|es6)$&apos;];
      if (!config.test.excludes) config.test.excludes = [&apos;\\.config\\.(js|es6)$&apos;];
    }
  }

  /**
   * Use built-in external document.
   * built-in external has number, string, boolean, etc...
   * @param {DocObject[]} results - this method pushes DocObject to this param.
   * @private
   * @see {@link src/BuiltinExternal/ECMAScriptExternal.js}
   */
  static _useBuiltinExternal(results) {
    let dirPath = path.resolve(__dirname, &apos;./BuiltinExternal/&apos;);
    this._walk(dirPath, (filePath)=&gt;{
      let temp = this._traverse(dirPath, filePath);
      temp.results.forEach((v)=&gt; v.builtinExternal = true);
      let res = temp.results.filter(v =&gt; v.kind === &apos;external&apos;);
      results.push(...res);
    });
  }

  /**
   * walk recursive in directory.
   * @param {string} dirPath - target directory path.
   * @param {function(entryPath: string)} callback - callback for find file.
   * @private
   */
  static _walk(dirPath, callback) {
    let entries = fs.readdirSync(dirPath);

    for (let entry of entries) {
      let entryPath = path.resolve(dirPath, entry);
      let stat = fs.statSync(entryPath);

      if (stat.isFile()) {
        callback(entryPath);
      } else if (stat.isDirectory()) {
        this._walk(entryPath, callback);
      }
    }
  }

  /**
   * traverse doc comment in JavaScript file.
   * @param {string} inDirPath - root directory path.
   * @param {string} filePath - target JavaScript file path.
   * @param {string} [packageName] - npm package name of target.
   * @param {string} [mainFilePath] - npm main file path of target.
   * @param {string} [pathPrefix] - prefix of import path from root directory.
   * @returns {Object} - return document that is traversed.
   * @property {DocObject[]} results - this is contained JavaScript file.
   * @property {AST} ast - this is AST of JavaScript file.
   * @private
   */
  static _traverse(inDirPath, filePath, packageName, mainFilePath, pathPrefix) {
    let ast;
    try {
      ast = ESParser.parse(filePath);
    } catch(e) {
      logger.w(`fail parse: ${filePath}`);
      return null;
    }

    let pathResolver = new PathResolver(inDirPath, filePath, packageName, mainFilePath, pathPrefix);
    let factory = new DocFactory(ast, pathResolver);

    ASTUtil.traverse(ast, (node, parent)=&gt;{
      factory.push(node, parent);
    });

    return {results: factory.results, ast: ast};
  }

  /**
   * traverse doc comment in test code file.
   * @param {string} type - test code type.
   * @param {string} inDirPath - root directory path.
   * @param {string} filePath - target test code file path.
   * @returns {Object} return document info that is traversed.
   * @property {DocObject[]} results - this is contained test code.
   * @property {AST} ast - this is AST of test code.
   * @private
   */
  static _traverseForTest(type, inDirPath, filePath) {
    let ast;
    try {
      ast = ESParser.parse(filePath);
    } catch(e) {
      logger.w(`fail parse: ${filePath}`);
      return null;
    }
    let pathResolver = new PathResolver(inDirPath, filePath);
    let factory = new TestDocFactory(type, ast, pathResolver);

    ASTUtil.traverse(ast, (node, parent)=&gt;{
      factory.push(node, parent);
    });

    return {results: factory.results, ast: ast};
  }
}
</code></pre>
</div>

<footer class="footer">
  Generated by <a href="https://esdoc.org">ESDoc<span data-ice="esdocVersion">(0.0.2)</span></a>
</footer>

<script src="script/search_index.js"></script>
<script src="script/search.js"></script>
<script src="script/pretty-print.js"></script>
<script src="script/inherited-summary.js"></script>
<script src="script/test-summary.js"></script>
<script src="script/inner-link.js"></script>
</body>
</html>
